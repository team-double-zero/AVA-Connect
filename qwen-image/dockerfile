FROM nvidia/cuda:12.1.1-runtime-ubuntu22.04

# 비대화형 + 한국 미러(카카오)로 교체 + 재시도 옵션 추가
ARG UBUNTU_MIRROR=mirror.kakao.com
ENV DEBIAN_FRONTEND=noninteractive

# 미러 바꾸고, 재시도/노캐시로 업데이트 후 설치
RUN sed -i "s|archive.ubuntu.com|${UBUNTU_MIRROR}|g; s|security.ubuntu.com|${UBUNTU_MIRROR}|g" /etc/apt/sources.list \
 && apt-get update -o Acquire::Retries=5 -o Acquire::http::No-Cache=true -o Acquire::https::No-Cache=true \
 && apt-get install -y --no-install-recommends ca-certificates python3-pip git \
 && rm -rf /var/lib/apt/lists/*

# 최신 pip
RUN python3 -m pip install --upgrade pip

# 의존성 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

WORKDIR /app
COPY . .

CMD ["python3", "qwen_test.py", "example.json"]